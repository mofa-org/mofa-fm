nodes:
  - id: NODE_ID
    # Do not build the server; it runs outside as a dynamic node
    path: dynamic
    inputs:
      audio: primespeech/audio
      text: asr/transcription
      speech_started: speech-monitor/speech_started
      speech_ended: speech-monitor/speech_ended
    outputs:
      - audio
      - text

  - id: speech-monitor
    path: dora-speechmonitor
    inputs:
      audio:
        source: NODE_ID/audio
        queue_size: 1000000
    outputs:
      - speech_started
      - speech_ended
      - question_ended
      - is_speaking
      - audio_segment
      - speech_probability
      - log
    env:
      MIN_AUDIO_AMPLITUDE: 0.01
      ACTIVE_FRAME_THRESHOLD_MS: 100
      USER_SILENCE_THRESHOLD_MS: 1500
      SILENCE_THRESHOLD_MS: 500
      QUESTION_END_SILENCE_MS: 3000
      AUDIO_FRAMES_THRESHOLD_MS: 10000
      VAD_THRESHOLD: 0.6
      VAD_ENABLED: true
      SAMPLE_RATE: 16000
      LOG_LEVEL: INFO

  - id: asr
    path: dora-asr
    inputs:
      audio:
        source: speech-monitor/audio_segment
        queue_size: 10
    outputs:
      - transcription
      - language_detected
      - processing_time
      - confidence
      - log
    env:
      ASR_ENGINE: funasr
      LANGUAGE: zh
      ENABLE_PUNCTUATION: true
      ENABLE_LANGUAGE_DETECTION: true
      ENABLE_CONFIDENCE_SCORE: false
      ASR_MODELS_DIR: $HOME/.dora/models/asr
      LOG_LEVEL: INFO

  - id: maas-client
    # Use prebuilt binary shipped in the image
    path: /usr/local/bin/dora-maas-client
    inputs:
      text: asr/transcription
      text_to_audio: NODE_ID/text
    outputs:
      - text
      - status
      - log
    env:
      CONFIG: maas_mcp_browser_config.toml
      LOG_LEVEL: INFO

  - id: text-segmenter
    path: dora-text-segmenter
    inputs:
      text: maas-client/text
      tts_complete: primespeech/segment_complete
    outputs:
      - text_segment
      - status
      - metrics
    env:
      ENABLE_BACKPRESSURE: "false"
      SEGMENT_MODE: "sentence"
      MIN_SEGMENT_LENGTH: "5"
      MAX_SEGMENT_LENGTH: "20"
      PUNCTUATION_MARKS: "。！？.!?"
      LOG_LEVEL: "INFO"

  - id: primespeech
    path: dora-primespeech
    inputs:
      text: text-segmenter/text_segment
    outputs:
      - audio
      - status
      - segment_complete
    env:
      PRIMESPEECH_MODEL_DIR: $HOME/.dora/models/primespeech
      VOICE_NAME: Doubao
      TEXT_LANG: zh
      PROMPT_LANG: zh
      TOP_K: 5
      TOP_P: 1.0
      TEMPERATURE: 1.0
      SPEED_FACTOR: 1.0
      USE_GPU: false
      NUM_THREADS: 4
      RETURN_FRAGMENT: "false"
      LOG_LEVEL: "INFO"
      ENABLE_INTERNAL_SEGMENTATION: "true"
      TTS_MAX_SEGMENT_LENGTH: "100"
      TTS_MIN_SEGMENT_LENGTH: "20"

  - id: audio-player
    path: dynamic
    inputs:
      audio: primespeech/audio
    outputs:
      - buffer_status
      - status

  - id: viewer
    path: dynamic
    inputs:
      transcription: asr/transcription
      llm_output: maas-client/text
      segment: text-segmenter/text_segment
      speech_started: speech-monitor/speech_started
      speech_ended: speech-monitor/speech_ended
